#!/usr/bin/python3
#-*- coding: utf-8 -*-
##############################################
# Home	: http://netkiller.github.io
# Author: Neo <netkiller@msn.com>
##############################################

try:
	import time
	import sys
	import socket
	import os
	from optparse import OptionParser
except ImportError as err:
	print("Error: %s" %(err))

class Logpush():
	
	def __init__(self):
		self.line_terminators = ('\r\n', '\n', '\r')
	def follow(self, filepath):
		self.file = open(filepath, 'rb')
		self.file.seek(0, 2)
		while 1:
			where = self.file.tell()
			line = self.file.readline()
			if line :
				print(line)
			else:
				self.file.seek(where)
				time.sleep(1)
	def sendto(self, host, port, sleep, filepath):
		sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
		#sock.sendto(bytes("-----\n","utf8"), (host, port))
		self.file = open(filepath, 'rb')
		self.file.seek(0, 2)
		while True:
			where = self.file.tell()
			line = self.file.readline()
			if line :
				print(line)
				sock.sendto(line, (host, port))
				time.sleep(sleep)
			else:
				self.file.seek(where)
				time.sleep(sleep)
	def usage(self):
		print("\n  Homepage: http://netkiller.github.io\tAuthor: Neo <netkiller@msn.com>")				
	def main(self):
		try:
			parser = OptionParser(usage='usage: %prog [options] filename')
			parser.add_option('-s', '--sendto', dest='sendto', default=False, action='store_true', help='push log to remote host')						  
			parser.add_option('-H', '--host', dest='host', default='localhost', metavar='localhost', type='str', help='hostname')
			parser.add_option('-p', '--port', dest='port', default=1214, metavar='1214', type='int',  help='port')
			parser.add_option('', '--sleep', dest='sleep', default=0.5, metavar='0.5', type='float',
						  help='with -s, sleep  for  approximately S  seconds between iterations')
			parser.add_option('-d','--daemon', dest='daemon', default=False, action='store_true', help='run as daemon')						  
			
			(options, args) = parser.parse_args()
			print(options.daemon)
			if not len(args) == 1:
				parser.print_help()
				self.usage()
				sys.exit(1)
			else:
				if options.sendto:
					if options.daemon:
						pid = os.fork()
						if pid > 0:
							sys.exit(0)
					self.sendto(options.host, options.port, options.sleep, args[0])
				else:
					self.follow(args[0])

		except Exception as err:
			print("Error: %s %s" %(err, ''))
			sys.exit(1)
		
if __name__ == '__main__':
	try:
		log = Logpush()
		log.main()
	except KeyboardInterrupt:
		print ("Crtl+C Pressed. Shutting down.")